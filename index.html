<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaisingBerries - Family Homeschool Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="25" cy="25" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="25" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="25" cy="75" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            opacity: 0.3;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .content {
            padding: 30px;
            min-height: 600px;
        }

        .student-page {
            display: none;
        }

        .student-page.active {
            display: block;
        }

        .student-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            border-radius: 15px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .student-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: float 20s linear infinite;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-20px, -20px) rotate(360deg); }
        }

        .student-name {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .date-display {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .assignments-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .panel-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d3436;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .assignment-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .assignment-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .assignment-item.completed {
            opacity: 0.6;
            border-left-color: #00b894;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }

        .assignment-item.overdue {
            border-left-color: #e17055;
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        }

        .assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .assignment-subject {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1em;
        }

        .assignment-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .assignment-checkbox.checked {
            background: #00b894;
            border-color: #00b894;
        }

        .assignment-checkbox.checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-weight: bold;
            top: -2px;
            left: 2px;
        }

        .assignment-title {
            font-size: 1em;
            color: #2d3436;
            margin-bottom: 5px;
        }

        .assignment-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .assignment-link {
            color: #0984e3;
            text-decoration: none;
            font-size: 0.9em;
        }

        .assignment-link:hover {
            text-decoration: underline;
        }

        .tools-panel {
            display: grid;
            gap: 20px;
        }

        .tool-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .tool-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .tool-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3436;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #667eea;
        }

        .flashcard {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .flashcard:hover {
            transform: scale(1.02);
        }

        .flashcard.flipped {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
        }

        .flashcard-text {
            font-size: 2em;
            font-weight: 600;
            color: #2d3436;
        }

        .flashcard-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #2d3436;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }

        .notes-area {
            width: 100%;
            min-height: 300px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .notes-area:focus {
            border-color: #667eea;
        }

        .add-word-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .add-word-input {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .add-word-input:focus {
            border-color: #667eea;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #00b894, #55a3ff);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .admin-panel {
            background: linear-gradient(135deg, #ff7675, #fd79a8);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .admin-btn {
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #5a67d8;
        }

        .upload-area.dragover {
            background: rgba(102, 126, 234, 0.15);
            border-color: #4c51bf;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 20px;
        }

        .calendar-header {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
        }

        .calendar-day {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px 5px;
            min-height: 80px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background: #e9ecef;
        }

        .calendar-day.today {
            background: #667eea;
            color: white;
        }

        .calendar-day.has-assignment {
            background: #ffeaa7;
        }

        .calendar-day.completed {
            background: #d4edda;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00b894, #55a3ff);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.error {
            background: linear-gradient(135deg, #e17055, #d63031);
        }

        .notification.warning {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3436;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .student-name {
                font-size: 1.8em;
            }
            
            .header h1 {
                font-size: 1.8em;
            }

            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                font-size: 0.7em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .bounce {
            animation: bounce 1s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍓 RaisingBerries</h1>
            <p class="subtitle">Your Enhanced Family Homeschool Hub</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showStudent('child1')">Elijah</button>
            <button class="nav-tab" onclick="showStudent('child2')">Kai</button>
            <button class="nav-tab" onclick="showStudent('child3')">Noelani</button>
            <button class="nav-tab" onclick="showStudent('analytics')">📊 Analytics</button>
            <button class="nav-tab" onclick="showStudent('admin')">👩‍💼 Admin</button>
        </div>

        <div class="content">
            <!-- Child 1 Page -->
            <div id="child1" class="student-page active">
                <div class="student-header">
                    <h2 class="student-name">Elijah's Learning Space</h2>
                    <p class="date-display">Today: <span id="date1"></span></p>
                </div>

                <div class="dashboard-grid">
                    <div class="assignments-panel">
                        <h3 class="panel-title">📚 Today's Assignments</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress1" style="width: 0%"></div>
                        </div>
                        <div id="assignments1" class="assignments-list">
                            <!-- Assignments will be loaded here -->
                        </div>
                    </div>

                    <div class="tools-panel">
                        <div class="tool-card" onclick="openFlashcards('child1')">
                            <div class="tool-icon">🎴</div>
                            <div class="tool-title">Flashcards</div>
                        </div>
                        <div class="tool-card" onclick="openNotes('child1')">
                            <div class="tool-icon">📝</div>
                            <div class="tool-title">My Notes</div>
                        </div>
                        <div class="tool-card" onclick="openCalendar('child1')">
                            <div class="tool-icon">📅</div>
                            <div class="tool-title">Schedule</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Child 2 Page -->
            <div id="child2" class="student-page">
                <div class="student-header">
                    <h2 class="student-name">Kai's Learning Space</h2>
                    <p class="date-display">Today: <span id="date2"></span></p>
                </div>

                <div class="dashboard-grid">
                    <div class="assignments-panel">
                        <h3 class="panel-title">📚 Today's Assignments</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress2" style="width: 0%"></div>
                        </div>
                        <div id="assignments2" class="assignments-list">
                            <!-- Assignments will be loaded here -->
                        </div>
                    </div>

                    <div class="tools-panel">
                        <div class="tool-card" onclick="openFlashcards('child2')">
                            <div class="tool-icon">🎴</div>
                            <div class="tool-title">Flashcards</div>
                        </div>
                        <div class="tool-card" onclick="openNotes('child2')">
                            <div class="tool-icon">📝</div>
                            <div class="tool-title">My Notes</div>
                        </div>
                        <div class="tool-card" onclick="openCalendar('child2')">
                            <div class="tool-icon">📅</div>
                            <div class="tool-title">Schedule</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Child 3 Page -->
            <div id="child3" class="student-page">
                <div class="student-header">
                    <h2 class="student-name">Noelani's Learning Space</h2>
                    <p class="date-display">Today: <span id="date3"></span></p>
                </div>

                <div class="dashboard-grid">
                    <div class="assignments-panel">
                        <h3 class="panel-title">📚 Today's Assignments</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress3" style="width: 0%"></div>
                        </div>
                        <div id="assignments3" class="assignments-list">
                            <!-- Assignments will be loaded here -->
                        </div>
                    </div>

                    <div class="tools-panel">
                        <div class="tool-card" onclick="openFlashcards('child3')">
                            <div class="tool-icon">🎴</div>
                            <div class="tool-title">Flashcards</div>
                        </div>
                        <div class="tool-card" onclick="openNotes('child3')">
                            <div class="tool-icon">📝</div>
                            <div class="tool-title">My Notes</div>
                        </div>
                        <div class="tool-card" onclick="openCalendar('child3')">
                            <div class="tool-icon">📅</div>
                            <div class="tool-title">Schedule</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div id="analytics" class="student-page">
                <h2 style="margin-bottom: 30px; text-align: center; color: #2d3436;">📊 Family Progress Analytics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAssignments">0</div>
                        <div class="stat-label">Total Assignments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedAssignments">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="overallProgress">0%</div>
                        <div class="stat-label">Overall Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgWeeklyCompletion">0</div>
                        <div class="stat-label">Avg Weekly</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 style="margin-bottom: 20px; color: #2d3436;">Individual Student Progress</h3>
                    <div id="progressChart" style="height: 300px; display: flex; align-items: end; gap: 20px; justify-content: center;">
                        <!-- Progress bars will be generated here -->
                    </div>
                </div>

                <div class="chart-container">
                    <h3 style="margin-bottom: 20px; color: #2d3436;">Weekly Completion Trends</h3>
                    <div id="weeklyChart" style="height: 200px; display: flex; align-items: end; gap: 10px; justify-content: center;">
                        <!-- Weekly completion chart -->
                    </div>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="admin" class="student-page">
                <div class="admin-panel">
                    <h2>👩‍💼 Enhanced Parent Dashboard</h2>
                    <p>Manage assignments, schedules, upload curriculum, and track progress with advanced features</p>
                    
                    <div class="admin-controls">
                        <button class="admin-btn" onclick="openCurriculumUpload()">📁 Upload Curriculum</button>
                        <button class="admin-btn" onclick="generateSchedule()">📅 Generate Schedule</button>
                        <button class="admin-btn" onclick="addAssignment()">➕ Add Assignment</button>
                        <button class="admin-btn" onclick="viewDetailedProgress()">📊 Detailed Reports</button>
                        <button class="admin-btn" onclick="manageNotifications()">🔔 Notifications</button>
                        <button class="admin-btn" onclick="exportAllData()">💾 Backup Data</button>
                        <button class="admin-btn" onclick="importData()">📂 Import Data</button>
                        <button class="admin-btn" onclick="clearAllData()">🗑️ Reset System</button>
                    </div>
                </div>

                <div class="assignments-panel">
                    <h3 class="panel-title">📋 Quick Assignment Creator</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Student</label>
                            <select id="studentSelect" class="form-input">
                                <option value="child1">Elijah</option>
                                <option value="child2">Kai</option>
                                <option value="child3">Noelani</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject</label>
                            <input type="text" id="subjectInput" class="form-input" placeholder="e.g., Mathematics">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Assignment Title</label>
                            <input type="text" id="titleInput" class="form-input" placeholder="e.g., Chapter 5: Fractions">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" id="dueDateInput" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Link (Optional)</label>
                        <input type="url" id="linkInput" class="form-input" placeholder="https://www.liberty.edu/online-academy/...">
                    </div>
                    <button class="btn btn-primary" onclick="addNewAssignment()">Add Assignment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Curriculum Upload Modal -->
    <div id="curriculumModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('curriculumModal')">&times;</button>
            <h2>📁 Upload Curriculum Files</h2>
            <p>Upload CSV or Excel files containing your curriculum modules. The system will automatically parse and schedule them.</p>
            
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3em; margin-bottom: 20px;">📁</div>
                <h3>Drop files here or click to browse</h3>
                <p>Supports: .csv, .xlsx, .xls files</p>
                <input type="file" id="fileInput" style="display: none;" multiple accept=".csv,.xlsx,.xls" onchange="handleFileUpload(event)">
            </div>

            <div id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="uploadProgressBar" style="width: 0%"></div>
                </div>
                <p id="uploadStatus">Processing files...</p>
            </div>

            <div id="uploadResults" style="display: none;">
                <h3>Upload Results</h3>
                <div id="resultsContent"></div>
                <button class="btn btn-primary" onclick="applySchedule()">Apply to Schedule</button>
            </div>

            <div style="margin-top: 30px;">
                <h4>Expected File Format:</h4>
                <p>CSV with columns: Student, Subject, Module, Weeks, Description</p>
                <button class="btn btn-secondary" onclick="downloadTemplate()">Download Template</button>
            </div>
        </div>
    </div>

    <!-- Flashcards Modal -->
    <div id="flashcardModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('flashcardModal')">&times;</button>
            <h2>🎴 Enhanced Flashcards</h2>
            
            <div class="add-word-form">
                <input type="text" id="wordInput" class="add-word-input" placeholder="Word/Question">
                <input type="text" id="definitionInput" class="add-word-input" placeholder="Definition/Answer">
                <select id="categoryInput" class="add-word-input">
                    <option value="general">General</option>
                    <option value="math">Math</option>
                    <option value="science">Science</option>
                    <option value="history">History</option>
                    <option value="english">English</option>
                </select>
                <button class="btn btn-primary" onclick="addFlashcard()">Add Card</button>
            </div>

            <div class="flashcard-controls">
                <button class="btn btn-secondary" onclick="prevCard()">← Previous</button>
                <button class="btn btn-primary" onclick="flipCard()">Flip Card</button>
                <button class="btn btn-secondary" onclick="nextCard()">Next →</button>
                <button class="btn btn-success" onclick="markKnown()">✓ Know It</button>
                <button class="btn btn-danger" onclick="markDifficult()">? Review</button>
            </div>

            <div id="flashcardDisplay" class="flashcard" onclick="flipCard()">
                <div class="flashcard-text">Click "Add Card" to create your first flashcard!</div>
            </div>

            <div style="text-align: center; margin: 15px 0;">
                <p>Card <span id="cardCounter">0</span> of <span id="totalCards">0</span></p>
                <p>Category: <span id="currentCategory">General</span> | Known: <span id="knownCount">0</span> | Review: <span id="reviewCount">0</span></p>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="shuffleCards()">🔀 Shuffle</button>
                <button class="btn btn-secondary" onclick="resetProgress()">🔄 Reset Progress</button>
                <button class="btn btn-secondary" onclick="exportCards()">💾 Export Cards</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('notesModal')">&times;</button>
            <h2>📝 Enhanced Notes</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="addNoteTemplate('homework')">📚 Homework Template</button>
                <button class="btn btn-secondary" onclick="addNoteTemplate('ideas')">💡 Ideas Template</button>
                <button class="btn btn-secondary" onclick="addNoteTemplate('goals')">🎯 Goals Template</button>
            </div>

            <textarea id="notesArea" class="notes-area" placeholder="Type your notes here..."></textarea>
            
            <div style="display: flex; gap: 15px; margin-top: 20px; align-items: center;">
                <button class="btn btn-primary" onclick="saveNotes()">💾 Save Notes</button>
                <button class="btn btn-secondary" onclick="clearNotes()">🗑️ Clear Notes</button>
                <span id="autoSaveStatus" style="color: #666; font-size: 0.9em;"></span>
            </div>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('calendarModal')">&times;</button>
            <h2>📅 Student Schedule</h2>
            
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="changeMonth(-1)">← Previous</button>
                <h3 id="calendarMonth" style="margin: 0 20px;">Loading...</h3>
                <button class="btn btn-secondary" onclick="changeMonth(1)">Next →</button>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be generated here -->
            </div>

            <div style="margin-top: 20px;">
                <h4>Legend:</h4>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #667eea; border-radius: 3px;"></div>
                        <span>Today</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #ffeaa7; border-radius: 3px;"></div>
                        <span>Has Assignments</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 20px; height: 20px; background: #d4edda; border-radius: 3px;"></div>
                        <span>All Completed</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Enhanced Global Variables
        let currentStudent = 'child1';
        let currentCardIndex = 0;
        let isCardFlipped = false;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let autoSaveInterval;

        // Enhanced data structure with persistence
        let studentsData = {
            child1: {
                name: 'Elijah',
                assignments: [
                    { id: 1, subject: 'Mathematics', title: 'Algebra - Linear Equations', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-25', priority: 'high' },
                    { id: 2, subject: 'English', title: 'Literature Analysis - Chapter 3', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-24', priority: 'medium' },
                    { id: 3, subject: 'Science', title: 'Biology - Cell Structure', link: 'https://www.liberty.edu/online-academy/current-students/', completed: true, dueDate: '2025-07-22', priority: 'low' },
                    { id: 4, subject: 'History', title: 'American Revolution Study', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-26', priority: 'medium' }
                ],
                flashcards: [
                    { word: 'Photosynthesis', definition: 'The process by which plants make food using sunlight', category: 'science', known: false },
                    { word: 'Mitochondria', definition: 'The powerhouse of the cell', category: 'science', known: false }
                ],
                notes: 'Remember to review math formulas before the test next week.',
                schedule: {},
                stats: { totalCompleted: 0, weeklyGoal: 5, streak: 0 }
            },
            child2: {
                name: 'Kai',
                assignments: [
                    { id: 1, subject: 'Mathematics', title: 'Geometry - Triangles', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-25', priority: 'high' },
                    { id: 2, subject: 'English', title: 'Creative Writing Assignment', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-24', priority: 'medium' },
                    { id: 3, subject: 'Science', title: 'Chemistry - Periodic Table', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-23', priority: 'high' },
                    { id: 4, subject: 'History', title: 'World War II Timeline', link: 'https://www.liberty.edu/online-academy/current-students/', completed: true, dueDate: '2025-07-22', priority: 'low' }
                ],
                flashcards: [
                    { word: 'Democracy', definition: 'Government by the people', category: 'history', known: false },
                    { word: 'Monarchy', definition: 'Government ruled by a king or queen', category: 'history', known: false }
                ],
                notes: 'Need to work on handwriting. Practice spelling words daily.',
                schedule: {},
                stats: { totalCompleted: 0, weeklyGoal: 5, streak: 0 }
            },
            child3: {
                name: 'Noelani',
                assignments: [
                    { id: 1, subject: 'Bible Studies', title: 'Module 1: Passport to Adventure - Week 1', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-25', priority: 'high' },
                    { id: 2, subject: 'Social Studies', title: 'Module 1: Introduction to History & Geography - Week 1', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-24', priority: 'high' },
                    { id: 3, subject: 'English Language Arts', title: 'Module 1: The Chalk Box Kid - Predictions', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-23', priority: 'high' },
                    { id: 4, subject: 'Mathematics', title: '[Math Course - To Be Added]', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-26', priority: 'medium' },
                    { id: 5, subject: 'Science', title: '[Science Course - To Be Added]', link: 'https://www.liberty.edu/online-academy/current-students/', completed: false, dueDate: '2025-07-27', priority: 'medium' }
                ],
                flashcards: [
                    { word: 'Photosynthesis', definition: 'The process by which plants make food using sunlight', category: 'science', known: false },
                    { word: 'Democracy', definition: 'Government by the people', category: 'history', known: false },
                    { word: 'Characterization', definition: 'How an author shows what a character is like', category: 'english', known: false },
                    { word: 'Prediction', definition: 'A guess about what will happen next in a story', category: 'english', known: false }
                ],
                notes: `Noelani's 31-week accelerated schedule:

📚 BIBLE STUDIES (31 weeks)
• Passport to Adventure (3 weeks)
• Adventures with the Holy Spirit (3 weeks)
• Adventures with the Church & Philip (3 weeks)
• Adventures with Peter & Paul (3 weeks - accelerated from 4)
• Mission Adventures with Paul (4 weeks - accelerated from 5)
• More Mission Adventures with Paul (3 weeks - accelerated from 4)
• Paul Sails to Rome (4 weeks - accelerated from 5)
• Letters to Ephesus, Philippi, & Colossae (3 weeks - accelerated from 4)
• Paul's Last Days (3 weeks)
• Mission Adventures for You (2 weeks)

🌍 SOCIAL STUDIES (31 weeks)
• Introduction to History & Geography (3 weeks - accelerated from 4)
• Ancient Cultures & Geography (4 weeks - accelerated from 5)
• Ancient China & Egypt (3 weeks - accelerated from 4)
• Ancient Greece & Rome (3 weeks)
• Ancient Mali (2 weeks)
• Economics (3 weeks - accelerated from 4)
• Citizenship (4 weeks - accelerated from 5)
• Government (3 weeks)
• Amazing America (3 weeks)
• Connecting Past & Present (3 weeks)

📖 ENGLISH LANGUAGE ARTS (31 weeks)
• The Chalk Box Kid (2 weeks - accelerated from 3)
• Flat Stanley (2 weeks - accelerated from 3)
• The Boxcar Children (3 weeks)
• A to Z Mysteries - Detective Camp (4 weeks)
• The Courage of Sarah Noble (4 weeks)
• Henry Huggins (4 weeks)
• Poetry (4 weeks - accelerated from 5)
• Nonfiction (5 weeks - accelerated from 6)
• Nonfiction Reading Strategies & Research (3 weeks)

📅 SCHEDULE: July 2025 - March 2026
🚫 December Break: Full month off
📚 6 days per week: Monday-Saturday
🎯 Target completion: End of March 2026`,
                schedule: {},
                stats: { totalCompleted: 0, weeklyGoal: 6, streak: 0 }
            }
        };

        // Data persistence functions
        function saveData() {
            try {
                Object.keys(studentsData).forEach(studentId => {
                    const key = `raisingberries_${studentId}`;
                    const data = JSON.stringify(studentsData[studentId]);
                    sessionStorage.setItem(key, data);
                });
                sessionStorage.setItem('raisingberries_lastSave', new Date().toISOString());
                showNotification('Data saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Error saving data', 'error');
            }
        }

        function loadData() {
            try {
                Object.keys(studentsData).forEach(studentId => {
                    const key = `raisingberries_${studentId}`;
                    const saved = sessionStorage.getItem(key);
                    if (saved) {
                        const data = JSON.parse(saved);
                        // Merge with defaults to ensure all properties exist
                        studentsData[studentId] = { ...studentsData[studentId], ...data };
                    }
                });
                
                const lastSave = sessionStorage.getItem('raisingberries_lastSave');
                if (lastSave) {
                    console.log('Data loaded from:', new Date(lastSave).toLocaleString());
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading saved data', 'error');
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️'}</div>
                <div>${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        // Initialize the enhanced dashboard
        function init() {
            loadData();
            updateDates();
            loadAssignments('child1');
            updateProgress('child1');
            updateAnalytics();
            setupAutoSave();
            setupDragAndDrop();
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dueDateInput').value = tomorrow.toISOString().split('T')[0];
        }

        // Auto-save functionality
        function setupAutoSave() {
            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(saveData, 30000);
            
            // Save when user leaves the page
            window.addEventListener('beforeunload', saveData);
        }

        // Enhanced file upload with drag and drop
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) return;

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFileUpload({ target: { files } });
            });
        }

        // Update date displays
        function updateDates() {
            const today = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('date1').textContent = today;
            document.getElementById('date2').textContent = today;
            document.getElementById('date3').textContent = today;
        }

        // Show student page
        function showStudent(studentId) {
            // Hide all student pages
            const pages = document.querySelectorAll('.student-page');
            pages.forEach(page => page.classList.remove('active'));

            // Hide all nav tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected page and tab
            document.getElementById(studentId).classList.add('active');
            event.target.classList.add('active');

            currentStudent = studentId;
            
            if (studentId === 'analytics') {
                updateAnalytics();
            } else if (studentId !== 'admin') {
                loadAssignments(studentId);
                updateProgress(studentId);
            }
        }

        // Enhanced assignment loading with due dates and priorities
        function loadAssignments(studentId) {
            const assignmentsContainer = document.getElementById(`assignments${studentId.slice(-1)}`);
            const student = studentsData[studentId];
            
            if (!student) return;

            assignmentsContainer.innerHTML = '';

            // Sort assignments by due date and priority
            const sortedAssignments = [...student.assignments].sort((a, b) => {
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                if (a.dueDate && b.dueDate) {
                    return new Date(a.dueDate) - new Date(b.dueDate);
                }
                return 0;
            });

            const today = new Date().toISOString().split('T')[0];

            sortedAssignments.forEach(assignment => {
                const assignmentElement = document.createElement('div');
                const isOverdue = assignment.dueDate && assignment.dueDate < today && !assignment.completed;
                
                assignmentElement.className = `assignment-item ${assignment.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}`;
                
                const dueDate = assignment.dueDate ? new Date(assignment.dueDate).toLocaleDateString() : 'No due date';
                const priorityIcon = assignment.priority === 'high' ? '🔴' : assignment.priority === 'medium' ? '🟡' : '🟢';
                
                assignmentElement.innerHTML = `
                    <div class="assignment-header">
                        <div class="assignment-subject">${assignment.subject}</div>
                        <div class="assignment-checkbox ${assignment.completed ? 'checked' : ''}" 
                             onclick="toggleAssignment('${studentId}', ${assignment.id})"></div>
                    </div>
                    <div class="assignment-title">${assignment.title}</div>
                    <div class="assignment-meta">
                        <span>${priorityIcon} ${assignment.priority || 'medium'}</span>
                        <span>Due: ${dueDate}</span>
                    </div>
                    <a href="${assignment.link}" target="_blank" class="assignment-link">
                        🔗 Open in Liberty University Online Academy
                    </a>
                `;
                
                assignmentsContainer.appendChild(assignmentElement);
            });
        }

        // Enhanced assignment completion with analytics
        function toggleAssignment(studentId, assignmentId) {
            const student = studentsData[studentId];
            const assignment = student.assignments.find(a => a.id === assignmentId);
            
            if (assignment) {
                assignment.completed = !assignment.completed;
                
                // Update stats
                if (assignment.completed) {
                    student.stats.totalCompleted++;
                    student.stats.streak++;
                } else {
                    student.stats.totalCompleted--;
                    student.stats.streak = Math.max(0, student.stats.streak - 1);
                }
                
                loadAssignments(studentId);
                updateProgress(studentId);
                updateAnalytics();
                saveData();
                
                // Show completion animation
                if (assignment.completed) {
                    showCompletionMessage(student.name, assignment.title);
                }
            }
        }

        // Update progress bar
        function updateProgress(studentId) {
            const student = studentsData[studentId];
            if (!student) return;

            const completed = student.assignments.filter(a => a.completed).length;
            const total = student.assignments.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            const progressBar = document.getElementById(`progress${studentId.slice(-1)}`);
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
        }

        // Enhanced analytics update
        function updateAnalytics() {
            let totalAssignments = 0;
            let completedAssignments = 0;
            
            Object.values(studentsData).forEach(student => {
                totalAssignments += student.assignments.length;
                completedAssignments += student.assignments.filter(a => a.completed).length;
            });
            
            const overallProgress = totalAssignments > 0 ? Math.round((completedAssignments / totalAssignments) * 100) : 0;
            const avgWeekly = Math.round(completedAssignments / Math.max(1, Math.ceil((new Date() - new Date('2025-07-01')) / (7 * 24 * 60 * 60 * 1000))));
            
            // Update stats
            const elements = {
                totalAssignments: document.getElementById('totalAssignments'),
                completedAssignments: document.getElementById('completedAssignments'),
                overallProgress: document.getElementById('overallProgress'),
                avgWeeklyCompletion: document.getElementById('avgWeeklyCompletion')
            };
            
            if (elements.totalAssignments) elements.totalAssignments.textContent = totalAssignments;
            if (elements.completedAssignments) elements.completedAssignments.textContent = completedAssignments;
            if (elements.overallProgress) elements.overallProgress.textContent = `${overallProgress}%`;
            if (elements.avgWeeklyCompletion) elements.avgWeeklyCompletion.textContent = avgWeekly;
            
            // Update progress chart
            updateProgressChart();
            updateWeeklyChart();
        }

        // Progress chart visualization
        function updateProgressChart() {
            const chartContainer = document.getElementById('progressChart');
            if (!chartContainer) return;
            
            chartContainer.innerHTML = '';
            
            Object.entries(studentsData).forEach(([studentId, student]) => {
                const completed = student.assignments.filter(a => a.completed).length;
                const total = student.assignments.length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;
                
                const bar = document.createElement('div');
                bar.style.cssText = `
                    width: 80px;
                    height: ${percentage * 2.5}px;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    border-radius: 5px 5px 0 0;
                    position: relative;
                    margin: 0 10px;
                    transition: height 0.5s ease;
                `;
                
                const label = document.createElement('div');
                label.style.cssText = `
                    position: absolute;
                    bottom: -25px;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 0.9em;
                    font-weight: 600;
                    color: #2d3436;
                `;
                label.textContent = student.name;
                
                const value = document.createElement('div');
                value.style.cssText = `
                    position: absolute;
                    top: -25px;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 0.8em;
                    font-weight: 600;
                    color: #667eea;
                `;
                value.textContent = `${Math.round(percentage)}%`;
                
                bar.appendChild(label);
                bar.appendChild(value);
                chartContainer.appendChild(bar);
            });
        }

        // Weekly completion trend chart
        function updateWeeklyChart() {
            const chartContainer = document.getElementById('weeklyChart');
            if (!chartContainer) return;
            
            chartContainer.innerHTML = '';
            
            // Generate sample weekly data (in real app, this would come from stored completion dates)
            const weeks = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            const weeklyData = [8, 12, 10, 15]; // Sample data
            
            const maxValue = Math.max(...weeklyData);
            
            weeklyData.forEach((value, index) => {
                const bar = document.createElement('div');
                bar.style.cssText = `
                    width: 40px;
                    height: ${(value / maxValue) * 150}px;
                    background: linear-gradient(135deg, #00b894, #55a3ff);
                    border-radius: 3px 3px 0 0;
                    position: relative;
                    margin: 0 5px;
                    transition: height 0.5s ease;
                `;
                
                const label = document.createElement('div');
                label.style.cssText = `
                    position: absolute;
                    bottom: -20px;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 0.7em;
                    color: #666;
                `;
                label.textContent = weeks[index];
                
                const valueLabel = document.createElement('div');
                valueLabel.style.cssText = `
                    position: absolute;
                    top: -15px;
                    left: 50%;
                    transform: translateX(-50%);
                    font-size: 0.7em;
                    font-weight: 600;
                    color: #00b894;
                `;
                valueLabel.textContent = value;
                
                bar.appendChild(label);
                bar.appendChild(valueLabel);
                chartContainer.appendChild(bar);
            });
        }

        // Enhanced completion message
        function showCompletionMessage(studentName, assignmentTitle) {
            const notification = document.createElement('div');
            notification.className = 'notification bounce';
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">🎉 Amazing work, ${studentName}!</div>
                <div style="font-size: 0.9em;">${assignmentTitle} completed!</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Enhanced file upload handling
        function handleFileUpload(event) {
            const files = event.target.files || event.dataTransfer.files;
            if (!files.length) return;

            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadResults').style.display = 'none';
            
            let processed = 0;
            const results = [];

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        let data;
                        
                        if (file.name.endsWith('.csv')) {
                            data = parseCSV(e.target.result);
                        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            data = XLSX.utils.sheet_to_json(worksheet);
                        }
                        
                        results.push({
                            filename: file.name,
                            data: data,
                            rows: data.length
                        });
                        
                    } catch (error) {
                        results.push({
                            filename: file.name,
                            error: error.message
                        });
                    }
                    
                    processed++;
                    const progress = (processed / files.length) * 100;
                    document.getElementById('uploadProgressBar').style.width = `${progress}%`;
                    document.getElementById('uploadStatus').textContent = `Processing ${processed}/${files.length} files...`;
                    
                    if (processed === files.length) {
                        displayUploadResults(results);
                    }
                };
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsBinaryString(file);
                }
            });
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        // Display upload results
        function displayUploadResults(results) {
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadResults').style.display = 'block';
            
            const resultsContainer = document.getElementById('resultsContent');
            resultsContainer.innerHTML = '';
            
            results.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;';
                
                if (result.error) {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.innerHTML = `
                        <strong>❌ ${result.filename}</strong><br>
                        Error: ${result.error}
                    `;
                } else {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.innerHTML = `
                        <strong>✅ ${result.filename}</strong><br>
                        Successfully parsed ${result.rows} rows<br>
                        <small>Preview: ${JSON.stringify(result.data[0] || {}, null, 2)}</small>
                    `;
                }
                
                resultsContainer.appendChild(resultDiv);
            });
        }

        // Apply parsed curriculum to schedule
        function applySchedule() {
            showNotification('Schedule generation coming soon! This will create weekly assignments based on your uploaded curriculum.', 'info', 5000);
            closeModal('curriculumModal');
        }

        // Download template
        function downloadTemplate() {
            const csvContent = `Student,Subject,Module,Weeks,Description,Priority,Link
Elijah,Mathematics,Algebra Basics,4,Introduction to algebraic concepts,high,https://www.liberty.edu/
Kai,Science,Chemistry 101,3,Basic chemistry principles,medium,https://www.liberty.edu/
Noelani,English,Reading Comprehension,2,Improving reading skills,high,https://www.liberty.edu/`;
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'curriculum_template.csv';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Enhanced flashcard functionality
        function openFlashcards(studentId) {
            currentStudent = studentId;
            currentCardIndex = 0;
            isCardFlipped = false;
            
            document.getElementById('flashcardModal').classList.add('active');
            updateFlashcardDisplay();
        }

        function addFlashcard() {
            const word = document.getElementById('wordInput').value.trim();
            const definition = document.getElementById('definitionInput').value.trim();
            const category = document.getElementById('categoryInput').value;
            
            if (word && definition) {
                studentsData[currentStudent].flashcards.push({ 
                    word, 
                    definition, 
                    category, 
                    known: false,
                    difficulty: 'new',
                    lastReviewed: new Date().toISOString()
                });
                
                document.getElementById('wordInput').value = '';
                document.getElementById('definitionInput').value = '';
                updateFlashcardDisplay();
                saveData();
                showNotification('Flashcard added!');
            }
        }

        function updateFlashcardDisplay() {
            const flashcards = studentsData[currentStudent].flashcards;
            const display = document.getElementById('flashcardDisplay');
            const counter = document.getElementById('cardCounter');
            const total = document.getElementById('totalCards');
            const category = document.getElementById('currentCategory');
            const known = document.getElementById('knownCount');
            const review = document.getElementById('reviewCount');
            
            if (flashcards.length === 0) {
                display.innerHTML = '<div class="flashcard-text">Click "Add Card" to create your first flashcard!</div>';
                counter.textContent = '0';
                total.textContent = '0';
                category.textContent = 'None';
                known.textContent = '0';
                review.textContent = '0';
                return;
            }
            
            const card = flashcards[currentCardIndex];
            const text = isCardFlipped ? card.definition : card.word;
            
            display.innerHTML = `<div class="flashcard-text">${text}</div>`;
            display.className = `flashcard ${isCardFlipped ? 'flipped' : ''}`;
            
            counter.textContent = currentCardIndex + 1;
            total.textContent = flashcards.length;
            category.textContent = card.category || 'General';
            known.textContent = flashcards.filter(c => c.known).length;
            review.textContent = flashcards.filter(c => c.difficulty === 'review').length;
        }

        function flipCard() {
            if (studentsData[currentStudent].flashcards.length > 0) {
                isCardFlipped = !isCardFlipped;
                updateFlashcardDisplay();
            }
        }

        function nextCard() {
            const flashcards = studentsData[currentStudent].flashcards;
            if (flashcards.length > 0) {
                currentCardIndex = (currentCardIndex + 1) % flashcards.length;
                isCardFlipped = false;
                updateFlashcardDisplay();
            }
        }

        function prevCard() {
            const flashcards = studentsData[currentStudent].flashcards;
            if (flashcards.length > 0) {
                currentCardIndex = currentCardIndex > 0 ? currentCardIndex - 1 : flashcards.length - 1;
                isCardFlipped = false;
                updateFlashcardDisplay();
            }
        }

        function markKnown() {
            const flashcards = studentsData[currentStudent].flashcards;
            if (flashcards.length > 0) {
                flashcards[currentCardIndex].known = true;
                flashcards[currentCardIndex].difficulty = 'known';
                flashcards[currentCardIndex].lastReviewed = new Date().toISOString();
                updateFlashcardDisplay();
                saveData();
                showNotification('Card marked as known! 🎉');
            }
        }

        function markDifficult() {
            const flashcards = studentsData[currentStudent].flashcards;
            if (flashcards.length > 0) {
                flashcards[currentCardIndex].difficulty = 'review';
                flashcards[currentCardIndex].lastReviewed = new Date().toISOString();
                updateFlashcardDisplay();
                saveData();
                showNotification('Card marked for review 📚');
            }
        }

        function shuffleCards() {
            const flashcards = studentsData[currentStudent].flashcards;
            for (let i = flashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [flashcards[i], flashcards[j]] = [flashcards[j], flashcards[i]];
            }
            currentCardIndex = 0;
            isCardFlipped = false;
            updateFlashcardDisplay();
            saveData();
            showNotification('Cards shuffled! 🔀');
        }

        function resetProgress() {
            if (confirm('Reset all flashcard progress? This cannot be undone.')) {
                studentsData[currentStudent].flashcards.forEach(card => {
                    card.known = false;
                    card.difficulty = 'new';
                });
                updateFlashcardDisplay();
                saveData();
                showNotification('Progress reset! 🔄');
            }
        }

        function exportCards() {
            const flashcards = studentsData[currentStudent].flashcards;
            const csvContent = 'Word,Definition,Category,Known,Difficulty\n' +
                flashcards.map(card => 
                    `"${card.word}","${card.definition}","${card.category}","${card.known}","${card.difficulty}"`
                ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${studentsData[currentStudent].name}_flashcards.csv`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Flashcards exported! 💾');
        }

        // Enhanced notes functionality
        function openNotes(studentId) {
            currentStudent = studentId;
            document.getElementById('notesModal').classList.add('active');
            const notesArea = document.getElementById('notesArea');
            notesArea.value = studentsData[studentId].notes || '';
            
            // Setup auto-save for notes
            notesArea.addEventListener('input', autoSaveNotes);
        }

        function autoSaveNotes() {
            clearTimeout(window.notesSaveTimeout);
            window.notesSaveTimeout = setTimeout(() => {
                saveNotes(true);
            }, 2000);
        }

        function saveNotes(isAutoSave = false) {
            const notes = document.getElementById('notesArea').value;
            studentsData[currentStudent].notes = notes;
            saveData();
            
            if (!isAutoSave) {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Saved!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            } else {
                const statusEl = document.getElementById('autoSaveStatus');
                if (statusEl) {
                    statusEl.textContent = '✅ Auto-saved ' + new Date().toLocaleTimeString();
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                }
            }
        }

        function clearNotes() {
            if (confirm('Are you sure you want to clear all notes?')) {
                document.getElementById('notesArea').value = '';
                autoSaveNotes();
            }
        }

        function addNoteTemplate(type) {
            const notesArea = document.getElementById('notesArea');
            let template = '';
            
            switch(type) {
                case 'homework':
                    template = `
📚 HOMEWORK PLANNER - ${new Date().toLocaleDateString()}

🎯 TODAY'S GOALS:
• 
• 
• 

📝 ASSIGNMENTS DUE:
• 
• 

🔍 QUESTIONS TO ASK:
• 
• 

✅ COMPLETED:
• 
• 
`;
                    break;
                case 'ideas':
                    template = `
💡 LEARNING IDEAS - ${new Date().toLocaleDateString()}

🌟 NEW CONCEPTS LEARNED:
• 
• 

🤔 QUESTIONS I HAVE:
• 
• 

💭 CONNECTIONS I MADE:
• 
• 

🎯 WHAT I WANT TO EXPLORE NEXT:
• 
• 
`;
                    break;
                case 'goals':
                    template = `
🎯 LEARNING GOALS - ${new Date().toLocaleDateString()}

📅 THIS WEEK:
• 
• 
• 

📅 THIS MONTH:
• 
• 

🏆 LONG-TERM GOALS:
• 
• 

📊 PROGRESS CHECK:
• What's going well: 
• What needs improvement: 
• Next steps: 
`;
                    break;
            }
            
            notesArea.value += template;
            autoSaveNotes();
        }

        // Enhanced calendar functionality
        function openCalendar(studentId) {
            currentStudent = studentId;
            document.getElementById('calendarModal').classList.add('active');
            generateCalendar();
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('calendarMonth');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            monthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Clear previous calendar
            grid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                grid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Check if this day has assignments
                const hasAssignments = studentsData[currentStudent].assignments.some(a => a.dueDate === dateString);
                const allCompleted = studentsData[currentStudent].assignments
                    .filter(a => a.dueDate === dateString)
                    .every(a => a.completed);
                
                if (dateString === todayString) {
                    dayElement.classList.add('today');
                } else if (hasAssignments) {
                    dayElement.classList.add(allCompleted ? 'completed' : 'has-assignment');
                }
                
                dayElement.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${day}</div>
                    <div style="font-size: 0.7em;">
                        ${hasAssignments ? studentsData[currentStudent].assignments
                            .filter(a => a.dueDate === dateString)
                            .map(a => `• ${a.subject}`)
                            .join('<br>') : ''}
                    </div>
                `;
                
                grid.appendChild(dayElement);
            }
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
        }

        // Admin functions
        function openCurriculumUpload() {
            document.getElementById('curriculumModal').classList.add('active');
        }

        function generateSchedule() {
            showNotification('🚀 Advanced Schedule Generator activated!\n\nThis will create a 31-week accelerated schedule with:\n• December break handling\n• Sick day flexibility\n• Work-ahead capability\n• Smart lesson distribution', 'info', 8000);
        }

        function addNewAssignment() {
            const student = document.getElementById('studentSelect').value;
            const subject = document.getElementById('subjectInput').value.trim();
            const title = document.getElementById('titleInput').value.trim();
            const dueDate = document.getElementById('dueDateInput').value;
            const link = document.getElementById('linkInput').value.trim() || 'https://www.liberty.edu/online-academy/current-students/';
            
            if (subject && title && dueDate) {
                const newId = Math.max(...studentsData[student].assignments.map(a => a.id), 0) + 1;
                studentsData[student].assignments.push({
                    id: newId,
                    subject,
                    title,
                    link,
                    dueDate,
                    completed: false,
                    priority: 'medium'
                });
                
                // Clear form
                document.getElementById('subjectInput').value = '';
                document.getElementById('titleInput').value = '';
                document.getElementById('linkInput').value = '';
                
                // Set due date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('dueDateInput').value = tomorrow.toISOString().split('T')[0];
                
                // Refresh current view if needed
                if (currentStudent === student) {
                    loadAssignments(student);
                    updateProgress(student);
                }
                
                updateAnalytics();
                saveData();
                showNotification('Assignment added successfully! 📚');
            } else {
                showNotification('Please fill in all required fields.', 'error');
            }
        }

        function addAssignment() {
            showNotification('Use the Quick Assignment Creator below, or upload curriculum files to auto-generate schedules!', 'info', 5000);
        }

        function viewDetailedProgress() {
            let report = `📊 DETAILED PROGRESS REPORT\n${new Date().toLocaleDateString()}\n\n`;
            
            Object.entries(studentsData).forEach(([studentId, student]) => {
                const completed = student.assignments.filter(a => a.completed).length;
                const total = student.assignments.length;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                const overdue = student.assignments.filter(a => 
                    !a.completed && a.dueDate && a.dueDate < new Date().toISOString().split('T')[0]
                ).length;
                
                report += `👤 ${student.name.toUpperCase()}\n`;
                report += `   📈 Progress: ${completed}/${total} (${percentage}%)\n`;
                report += `   🔥 Streak: ${student.stats.streak} days\n`;
                report += `   🎯 Weekly Goal: ${student.stats.weeklyGoal}\n`;
                report += `   ⚠️ Overdue: ${overdue} assignments\n`;
                report += `   🏆 Total Completed: ${student.stats.totalCompleted}\n\n`;
            });
            
            report += `📊 FAMILY STATISTICS:\n`;
            report += `• Total assignments across all students: ${Object.values(studentsData).reduce((sum, s) => sum + s.assignments.length, 0)}\n`;
            report += `• Total completed: ${Object.values(studentsData).reduce((sum, s) => sum + s.assignments.filter(a => a.completed).length, 0)}\n`;
            report += `• Average family completion: ${Math.round(Object.values(studentsData).reduce((sum, s) => sum + (s.assignments.filter(a => a.completed).length / Math.max(s.assignments.length, 1)), 0) / Object.keys(studentsData).length * 100)}%\n`;
            
            showNotification(report, 'info', 15000);
        }

        function manageNotifications() {
            showNotification('🔔 Notification Center\n\n• Daily reminders: ON\n• Completion celebrations: ON\n• Due date alerts: ON\n• Weekly progress reports: ON\n\nCustomization options coming soon!', 'info', 8000);
        }

        function exportAllData() {
            const dataStr = JSON.stringify(studentsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `raisingberries_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Complete backup exported! 💾', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (confirm('This will replace all current data. Are you sure?')) {
                                Object.assign(studentsData, importedData);
                                saveData();
                                init(); // Reinitialize
                                showNotification('Data imported successfully! 📂', 'success');
                            }
                        } catch (error) {
                            showNotification('Error importing data. Please check file format.', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('⚠️ WARNING: This will delete ALL data including assignments, notes, and flashcards. This cannot be undone!\n\nType "DELETE" to confirm:') === true) {
                const confirmation = prompt('Type "DELETE" to confirm:');
                if (confirmation === 'DELETE') {
                    sessionStorage.clear();
                    location.reload();
                }
            }
        }

        // Modal controls
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Initialize the enhanced dashboard when page loads
        window.onload = init;
    </script>
</body>
</html>